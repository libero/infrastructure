language: bash

env:
  global:
    - TERRAFORM_VERSION=0.12.17
    - TERRAFORM=../../terraform

branches:
  only:
    - master
    - /^latest\/.+$/

before_install:
  - TRAVIS_KEY=$encrypted_656a7d042f6e_key TRAVIS_IV=$encrypted_656a7d042f6e_iv .scripts/travis/git-crypt-unlock.sh travis-ci.key.enc
  - bash -c '[ "$(head -n 1 tf/registration--unstable.key)" == "-----BEGIN RSA PRIVATE KEY-----" ]'
  - scripts/download-terraform.sh
  - scripts/download-helm.sh
  - sudo apt-add-repository --yes --update ppa:ansible/ansible
  - sudo apt-get install ansible


script:
  - cd tf
  - rm -rf .terraform && ./terraform init --backend-config="key=unstable/terraform.tfstate" -input=false
  - ./terraform plan -var env=unstable -out /tmp/unstable.plan
  - rm -rf .terraform && ./terraform init --backend-config="key=demo/terraform.tfstate" -input=false
  - ./terraform plan -var env=demo -out /tmp/demo.plan
  - cd envs/franklin
  - rm -rf .terraform && $TERRAFORM init --backend-config="key=franklin/terraform.tfstate" -input=false
  - $TERRAFORM plan -out /tmp/franklin.plan
  - cd -

deploy:
  - provider: script
    script: rm -rf .terraform && ./terraform init --backend-config="key=unstable/terraform.tfstate" -input=false && ./terraform apply /tmp/unstable.plan
    skip_cleanup: true
    on:
      branch: master
  - provider: script
    script: rm -rf .terraform && ./terraform init --backend-config="key=demo/terraform.tfstate" -input=false && ./terraform apply /tmp/demo.plan
    skip_cleanup: true
    on:
      tags: true
  - provider: script
    script: ../scripts/terraform-apply.sh franklin && aws eks update-kubeconfig --name libero-eks--franklin && ../helm ls
    skip_cleanup: true
    on:
      branch: master
