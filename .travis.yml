language: bash

env:
  global:
    - TERRAFORM_VERSION=0.11.14

branches:
  only:
    - master

before_install:
  - TRAVIS_KEY=$encrypted_656a7d042f6e_key TRAVIS_IV=$encrypted_656a7d042f6e_iv .scripts/travis/git-crypt-unlock.sh travis-ci.key.enc
  - bash -c '[ "$(head -n 1 tf/registration.key)" == "-----BEGIN RSA PRIVATE KEY-----" ]'
  - cd tf
  - wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
  - unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip

script:
  - rm -rf .terraform && ./terraform init --backend-config="key=unstable/terraform.tfstate" -input=false
  - ./terraform plan -var env=unstable -out /tmp/unstable.plan
  - rm -rf .terraform && ./terraform init --backend-config="key=demo/terraform.tfstate" -input=false
  - ./terraform plan -var end=demo -out /tmp/demo.plan

deploy:
- provider: script
  script:
    - rm -rf .terraform && ./terraform init --backend-config="key=unstable/terraform.tfstate" -input=false
    - ./terraform apply /tmp/unstable.plan
  skip_cleanup: true
  on:
    branch: master
