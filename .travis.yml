language: bash

env:
  global:
    - TERRAFORM=../../terraform

branches:
  only:
    - master
    - /^latest\/.+$/

before_install:
  - TRAVIS_KEY=$encrypted_656a7d042f6e_key TRAVIS_IV=$encrypted_656a7d042f6e_iv .scripts/travis/git-crypt-unlock.sh travis-ci.key.enc
  - bash -c '[ "$(head -n 1 tf/registration--unstable.key)" == "-----BEGIN RSA PRIVATE KEY-----" ]'
  - scripts/download-terraform.sh
  - scripts/download-helm.sh
  - sudo scripts/download-awscli.sh


script:
  - cd tf
  - cd envs/franklin
  - rm -rf .terraform && $TERRAFORM init --backend-config="key=franklin/terraform.tfstate" -input=false
  - $TERRAFORM plan -out /tmp/franklin.plan
  - cd -

deploy:
  - provider: script
    script: ../scripts/terraform-apply.sh franklin && aws eks update-kubeconfig --name libero-eks--franklin && ../helm ls
    skip_cleanup: true
    on:
      branch: master
